---
show: step
version: 1.0
enable_checker: true
---

# 后台接口开发实战 1—文件夹的创建及文件列表查询接口开发

## 实验介绍

在之前的课程已经完成了项目开发的基本工作，这节实验开始真正的文件接口开发，将分为三个实验来完成，由浅入深，本节实验主要完成最简单的文件操作，包括文件夹的创建和查询接口，作为后面实验课程的基础。

#### 知识点

- 文件夹创建接口实现
- 文件列表查询接口实现
- 文件分类查看接口实现

#### 开发计划

- 开发内容：开发文件夹创建及文件列表查询接口。

- 开发耗时：实验预计完成时间为 2~4 小时
- 开发难点：熟练掌握接口开发流程及测试流程。

## 文件代码类创建

在之前数据库设计的时候，关于文件操作主要有两张表，分别是 `file` 和 `userfile` 表，下面我们完善这两张表基础代码。

### Mapper 层接口

在 `com.shiyanlou.file.mapper` 下之前已经创建好了 `FileMapper.java` 和 `UserfileMapper.java` 接口类，现在我们将这两个类都继承 BaseMapper，以便我们之后使用 MyBatis-Plus 来操作数据库，代码如下：

#### FileMapper 接口

```java
package com.shiyanlou.file.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.shiyanlou.file.model.File;

public interface FileMapper extends BaseMapper<File> {

}
```

#### UserfileMapper 接口

```java
package com.shiyanlou.file.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.shiyanlou.file.model.UserFile;

public interface UserfileMapper extends BaseMapper<UserFile> {

}
```

### Service 接口

在 `com.shiyanlou.file.service` 包下创建文件 Service 层接口 `FileService.java`，并初始化如下内容：

```java
package com.shiyanlou.file.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.shiyanlou.file.model.File;

public interface FileService extends IService<File> {

}
```

在 `com.shiyanlou.file.service` 包下创建用户文件 Service 层接口 `UserfileService.java`，并初始化如下内容：

```java
package com.shiyanlou.file.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.shiyanlou.file.model.UserFile;

public interface UserfileService extends IService<UserFile> {

}
```

### Service 实现

在 `com.shiyanlou.file.service.impl` 包下创建 `FileService.java` 接口的实现类 `FileServiceImpl.java`，代码如下：

```java
package com.shiyanlou.file.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.shiyanlou.file.mapper.FileMapper;
import com.shiyanlou.file.model.File;
import com.shiyanlou.file.service.FileService;

import org.springframework.stereotype.Service;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class FileServiceImpl extends ServiceImpl<FileMapper, File> implements FileService {

}
```

在 `com.shiyanlou.file.service.impl` 包下创建 `UserfileService.java` 接口的实现类 `UserfileServiceImpl.java`，代码如下：

```java
package com.shiyanlou.file.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.shiyanlou.file.mapper.UserfileMapper;
import com.shiyanlou.file.model.UserFile;
import com.shiyanlou.file.service.UserfileService;

import org.springframework.stereotype.Service;

@Service
public class UserfileServiceImpl extends ServiceImpl<UserfileMapper, UserFile> implements UserfileService {

}
```

在 `UserServiceImpl.java` 中添加 `getUserByToken` 方法，该方法通过 token 获取到用户信息，后面会频繁用到，可以用来校验 token，此段代码依赖 JWTUtil，需要在顶部注入，代码如下：

```java
import com.fasterxml.jackson.databind.ObjectMapper;
import com.shiyanlou.file.util.JWTUtil;
import io.jsonwebtoken.Claims;

@Slf4j
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService{
    
    @Resource
    JWTUtil jwtUtil;
    ...
    @Override
    public User getUserByToken(String token) {
        User tokenUserInfo = null;
        try {

            Claims c = jwtUtil.parseJWT(token);
            String subject = c.getSubject();
            ObjectMapper objectMapper = new ObjectMapper();
            tokenUserInfo = objectMapper.readValue(subject, User.class);

        } catch (Exception e) {
            log.error("解码异常");
            return null;

        }
        return tokenUserInfo;
    }
}
```

当调用该方法，如果返回 null，则认为 token 是无效的。

向 `UserService.java` 文件中补充如下代码：

```java
    User getUserByToken(String token);
```

## 文件夹创建接口开发

#### DTO 实体类

在 `com.shiyanlou.file.dto` 包下创建 `CreateFileDTO.java` 实体类，代码如下：

```java
package com.shiyanlou.file.dto;

import io.swagger.v3.oas.annotations.media.Schema;
import lombok.Data;

@Data
@Schema(name = "创建文件DTO",required = true)
public class CreateFileDTO {
    @Schema(description="文件名")
    private String fileName;
    @Schema(description="文件路径")
    private String filePath;
}
```

#### Controller 控制器层

在 `com.shiyanlou.file.controller` 包下创建 `FileController.java` 实体类，并增加文件夹创建接口，接口代码如下：

```java
package com.shiyanlou.file.controller;

import java.util.List;

import javax.annotation.Resource;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.shiyanlou.file.common.RestResult;
import com.shiyanlou.file.dto.CreateFileDTO;
import com.shiyanlou.file.model.User;
import com.shiyanlou.file.model.UserFile;
import com.shiyanlou.file.service.FileService;
import com.shiyanlou.file.service.UserService;
import com.shiyanlou.file.service.UserfileService;
import com.shiyanlou.file.util.DateUtil;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.extern.slf4j.Slf4j;


@Tag(name = "file", description = "该接口为文件接口，主要用来做一些文件的基本操作，如创建目录，删除，移动，复制等。")
@RestController
@Slf4j
@RequestMapping("/file")
public class FileController {

    @Resource
    FileService fileService;
    @Resource
    UserService userService;
    @Resource
    UserfileService userfileService;

    @Operation(summary = "创建文件", description = "目录(文件夹)的创建", tags = {"file"})
    @PostMapping(value = "/createfile")
    @ResponseBody
    public RestResult<String> createFile(@RequestBody CreateFileDTO createFileDto, @RequestHeader("token") String token) {


        User sessionUser = userService.getUserByToken(token);
        if (sessionUser == null) {
            RestResult.fail().message("token认证失败");
        }
        LambdaQueryWrapper<UserFile> lambdaQueryWrapper = new LambdaQueryWrapper<>();
        lambdaQueryWrapper.eq(UserFile::getFileName, "").eq(UserFile::getFilePath, "").eq(UserFile::getUserId, 0);
        List<UserFile> userfiles = userfileService.list(lambdaQueryWrapper);
        if (!userfiles.isEmpty()) {
            RestResult.fail().message("同目录下文件名重复");
        }

        UserFile userFile = new UserFile();
        userFile.setUserId(sessionUser.getUserId());
        userFile.setFileName(createFileDto.getFileName());
        userFile.setFilePath(createFileDto.getFilePath());
        userFile.setIsDir(1);
        userFile.setUploadTime(DateUtil.getCurrentTime());

        userfileService.save(userFile);
        return RestResult.success();
    }
}
```

## 文件列表查询接口开发

#### DTO 实体类

创建 DTO 实体类 `UserfileListDTO.java`，用来作为文件列表查询接口接收前台请求信息的载体，代码如下：

```java
package com.shiyanlou.file.dto;

import io.swagger.v3.oas.annotations.media.Schema;
import lombok.Data;

@Data
@Schema(name = "文件列表DTO",required = true)
public class UserfileListDTO {
    @Schema(description = "文件路径")
    private String filePath;
    @Schema(description = "当前页码")
    private Long currentPage;
    @Schema(description = "一页显示数量")
    private Long pageCount;
}
```

#### VO 实体类

创建 VO 实体类 `UserfileListVO.java`，用来作为文件列表查询接口给前台返回的信息载体，代码如下：

```java
package com.shiyanlou.file.vo;

import io.swagger.v3.oas.annotations.media.Schema;
import lombok.Data;

@Data
@Schema(description="用户文件列表VO")
public class UserfileListVO {
    @Schema(description="文件id")
    private Long fileId;
    @Schema(description="时间戳名称")
    private String timeStampName;
    @Schema(description="文件url")
    private String fileUrl;
    @Schema(description="文件大小")
    private Long fileSize;
    @Schema(description="是否是oss存储")
    private Integer isOSS;
    @Schema(description="引用数量")
    private Integer pointCount;
    @Schema(description="md5")
    private String identifier;
    @Schema(description="用户文件id")
    private Long userFileId;
    @Schema(description="用户id")
    private Long userId;

    @Schema(description="文件名")
    private String fileName;
    @Schema(description="文件路径")
    private String filePath;
    @Schema(description="扩展名")
    private String extendName;
    @Schema(description="是否是目录")
    private Integer isDir;
    @Schema(description="上传时间")
    private String uploadTime;
}
```

#### DAO 层代码编写

在 `resources/mybatis/mapper` 路径下创建 `UserfileMapper.xml`，并初始化内容如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shiyanlou.file.mapper.UserfileMapper">

</mapper>
```

在 `UserfileMapper.xml` 文件中创建用户文件分页查询 sql，代码如下：

```xml
...
<mapper namespace="com.shiyanlou.file.mapper.UserfileMapper">

    <select id="userfileList" resultType="com.shiyanlou.file.vo.UserfileListVO">
        select * from userfile a
        left join file on file.fileId = a.fileId
        <where>
            <if test="userfile.userId != null">
                and a.userId = #{userfile.userId}
            </if>
            <if test="userfile.filePath != null">
                and a.filePath = #{userfile.filePath}
            </if>
            <if test="userfile.extendName != null">
                and a.extendName = #{userfile.extendName}
            </if>
        </where>
        ORDER BY  isDir desc
        limit #{beginCount}, #{pageCount}
    </select>

</mapper>
```

在 `UserfileMapper.java` 接口类中，新增文件查询接口，代码如下：

```java
...
import java.util.List;
import com.shiyanlou.file.vo.UserfileListVO;

public interface UserfileMapper extends BaseMapper<UserFile> {
    List<UserfileListVO> userfileList(UserFile userfile, Long beginCount, Long pageCount);

}
```

#### Service 层代码编写

在 `UserfileService.java` 接口类中，新增获取文件列表接口，代码如下：

```java
import java.util.List;
import com.shiyanlou.file.vo.UserfileListVO;

public interface UserfileService extends IService<UserFile> {
    List<UserfileListVO> getUserFileByFilePath(String filePath, Long userId, Long currentPage, Long pageCount);
}
```

在 `UserfileServiceImpl.java` 中新增获取文件列表方法实现，代码如下：

```java
package com.shiyanlou.file.service.impl;

import java.util.List;

import javax.annotation.Resource;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.shiyanlou.file.mapper.UserfileMapper;
import com.shiyanlou.file.model.UserFile;
import com.shiyanlou.file.service.UserfileService;
import com.shiyanlou.file.vo.UserfileListVO;
import org.springframework.stereotype.Service;

@Service
public class UserfileServiceImpl extends ServiceImpl<UserfileMapper, UserFile> implements UserfileService {

    @Resource
    UserfileMapper userfileMapper;

    @Override
    public List<UserfileListVO> getUserFileByFilePath(String filePath, Long userId, Long currentPage, Long pageCount) {
        Long beginCount = (currentPage - 1) * pageCount;
        UserFile userfile = new UserFile();
        userfile.setUserId(userId);
        userfile.setFilePath(filePath);
        List<UserfileListVO> fileList = userfileMapper.userfileList(userfile, beginCount, pageCount);
        return fileList;
    }

}
```

#### Controller 层代码编写

在 `FileController.java` 接口中新增获取文件接口 `getUserfileList`，代码如下：

```java
import java.util.HashMap;
import java.util.Map;
import com.shiyanlou.file.vo.UserfileListVO;
import com.shiyanlou.file.dto.UserfileListDTO;

@Tag(name = "file", description = "该接口为文件接口，主要用来做一些文件的基本操作，如创建目录，删除，移动，复制等。")
@RestController
@Slf4j
@RequestMapping("/file")
public class FileController {
    ...
    @Operation(summary = "获取文件列表", description = "用来做前台文件列表展示", tags = { "file" })
    @GetMapping(value = "/getfilelist")
    @ResponseBody
    public RestResult<UserfileListVO> getUserfileList(UserfileListDTO userfileListDto,
            @RequestHeader("token") String token) {


        User sessionUser = userService.getUserByToken(token);
        if (sessionUser == null) {
            return RestResult.fail().message("token验证失败");

        }

        List<UserfileListVO> fileList = userfileService.getUserFileByFilePath(userfileListDto.getFilePath(),
                sessionUser.getUserId(), userfileListDto.getCurrentPage(), userfileListDto.getPageCount());

        LambdaQueryWrapper<UserFile> userFileLambdaQueryWrapper = new LambdaQueryWrapper<>();
        userFileLambdaQueryWrapper.eq(UserFile::getUserId, sessionUser.getUserId()).eq(UserFile::getFilePath, userfileListDto.getFilePath());
        int total = userfileService.count(userFileLambdaQueryWrapper);

        Map<String, Object> map = new HashMap<>();
        map.put("total", total);
        map.put("list", fileList);

        return RestResult.success().data(map);

    }
}
```

## 文件分类查询接口开发

创建 `com.shiyanlou.file.constant` 包，并在该包下新建 `FileConstant.java` 类，用来存放常量类，首先在该类中先初始化好文件分类的常量，代码如下：

```java
package com.shiyanlou.file.constant;

public class FileConstant {
    public static final String[] IMG_FILE = {"bmp", "jpg", "png", "tif", "gif", "jpeg"};
    public static final String[] DOC_FILE = {"doc", "docx", "ppt", "pptx", "xls", "xlsx", "txt", "hlp", "wps", "rtf", "html", "pdf"};
    public static final String[] VIDEO_FILE = {"avi", "mp4", "mpg", "mov", "swf"};
    public static final String[] MUSIC_FILE = {"wav", "aif", "au", "mp3", "ram", "wma", "mmf", "amr", "aac", "flac"};
    public static final int IMAGE_TYPE = 1;
    public static final int DOC_TYPE = 2;
    public static final int VIDEO_TYPE = 3;
    public static final int MUSIC_TYPE = 4;
    public static final int OTHER_TYPE = 5;
}
```

#### DAO 层代码编写

上面我们将常用的文件格式按照后缀分为 4 类，分别是图像类，文档类，视频类，音乐类，除了这 4 类的格式，其他格式我们统一放到其他类中，这样当做查询的时侯，查询具体某一类的文件，只需要传入对应的文件格式数组即可，查询其他类，则需要排除这些类，接下来我们首先来实现 sql，向 `UserfileMapper.xml` 文件中添加如下代码：

```xml
<sql id="selectByExtendName" >
    left join file on file.fileId = userfile.fileId
    where extendName in
    <foreach collection="fileNameList" open="(" close=")" separator="," item="fileName" >
        #{fileName}
    </foreach>
    and userId = #{userId}
</sql>
<sql id="selectByNotExtendName">
    left join file on file.fileId = userfile.fileId
    where extendName not in
    <foreach collection="fileNameList" open="(" close=")" separator="," item="fileName" >
        #{fileName}
    </foreach>
    and userId = #{userId}
</sql>
<select id="selectFileByExtendName" parameterType="com.shiyanlou.file.model.UserFile" resultType="com.shiyanlou.file.vo.UserfileListVO">
    select * from userfile
    <include refid="selectByExtendName"></include>
    limit #{beginCount}, #{pageCount}
</select>

<select id="selectCountByExtendName" parameterType="com.shiyanlou.file.model.UserFile" resultType="java.lang.Long">
    select count(*) from userfile
    <include refid="selectByExtendName"></include>
</select>

<select id="selectFileNotInExtendNames" parameterType="com.shiyanlou.file.model.UserFile" resultType="com.shiyanlou.file.vo.UserfileListVO">
    select * from userfile
    <include refid="selectByNotExtendName"></include>
    limit #{beginCount}, #{pageCount}
</select>

<select id="selectCountNotInExtendNames" parameterType="com.shiyanlou.file.model.UserFile" resultType="java.lang.Long">
    select count(*) from userfile
    <include refid="selectByNotExtendName"></include>
</select>
```

上面写了 4 个 sql，接下来在 `UserfileMapper.java` 中新增对应的 Mapper 接口，代码如下：

```java
List<UserfileListVO> selectFileByExtendName(List<String> fileNameList, Long beginCount, Long pageCount, long userId);
Long selectCountByExtendName(List<String> fileNameList, Long beginCount, Long pageCount, long userId);
List<UserfileListVO> selectFileNotInExtendNames(List<String> fileNameList, Long beginCount, Long pageCount, long userId);
Long selectCountNotInExtendNames(List<String> fileNameList, Long beginCount, Long pageCount, long userId);
```

#### Service 层代码编写

在 `UserfileService.java` 接口中，创建通过类型获取用户文件列表接口，代码如下：

```java
...
import java.util.Map;
public interface UserfileService extends IService<Userfile> {
    ...

    Map<String, Object> getUserFileByType(int fileType, Long currentPage, Long pageCount, Long userId);
}
```

向 `UserfileServiceImpl.java` 文件中补充如下代码：

```java
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import com.shiyanlou.file.constant.FileConstant;

@Service
public class UserfileServiceImpl extends ServiceImpl<UserfileMapper, UserFile> implements UserfileService {
    ...
    @Override
    public Map<String, Object> getUserFileByType(int fileType, Long currentPage, Long pageCount, Long userId) {
        Long beginCount = (currentPage - 1) * pageCount;
        List<UserfileListVO> fileList;
        Long total;
        if (fileType == FileConstant.OTHER_TYPE) {

            List<String> arrList = new ArrayList<>();
            arrList.addAll(Arrays.asList(FileConstant.DOC_FILE));
            arrList.addAll(Arrays.asList(FileConstant.IMG_FILE));
            arrList.addAll(Arrays.asList(FileConstant.VIDEO_FILE));
            arrList.addAll(Arrays.asList(FileConstant.MUSIC_FILE));

            fileList = userfileMapper.selectFileNotInExtendNames(arrList,beginCount, pageCount, userId);
            total = userfileMapper.selectCountNotInExtendNames(arrList,beginCount, pageCount, userId);
        } else {
            List<String> fileExtends = null;
            if (fileType == FileConstant.IMAGE_TYPE) {
                fileExtends = Arrays.asList(FileConstant.IMG_FILE);
            } else if (fileType == FileConstant.DOC_TYPE) {
                fileExtends = Arrays.asList(FileConstant.DOC_FILE);
            } else if (fileType == FileConstant.VIDEO_TYPE) {
                fileExtends = Arrays.asList(FileConstant.VIDEO_FILE);
            } else if (fileType == FileConstant.MUSIC_TYPE) {
                fileExtends = Arrays.asList(FileConstant.MUSIC_FILE);
            }
            fileList = userfileMapper.selectFileByExtendName(fileExtends, beginCount, pageCount,userId);
            total = userfileMapper.selectCountByExtendName(fileExtends, beginCount, pageCount,userId);
        }
        Map<String, Object> map = new HashMap<>();
        map.put("list",fileList);
        map.put("total", total);
        return map;
    }
}
```

#### Controller 层代码编写

向 `FileController.java` 文件中补充如下代码：

```java
@Operation(summary = "通过文件类型选择文件", description = "该接口可以实现文件格式分类查看", tags = {"file"})
@GetMapping(value = "/selectfilebyfiletype")
@ResponseBody
public RestResult<List<Map<String, Object>>> selectFileByFileType(int fileType, Long currentPage, Long pageCount, @RequestHeader("token") String token) {

    User sessionUser = userService.getUserByToken(token);
    if (sessionUser == null) {
        return RestResult.fail().message("token验证失败");
    }
    long userId = sessionUser.getUserId();

    Map<String, Object> map = userfileService.getUserFileByType(fileType, currentPage, pageCount, userId);
    return RestResult.success().data(map);

}
```

## 测试

启动 MySQL 数据库：

```bash
sudo service mysql start
```

点击 run 启动项目，在控制台查看项目启动成功之后，点击右侧 Web 服务进行访问。在地址栏之后添加 `/doc.html` 即可访问文档。

先使用登录接口获取 token，然后点击创建文件按钮，进行接口测试，在请求头部填入 token 串，如下图：

![图片描述](https://doc.shiyanlou.com/courses/3472/1557563/b847abdc7dbde9af54a6027858640fbb-0/wm)

#### 创建文件接口测试

在根目录下创建文件夹，名称为 `测试1`，点击发送，如果显示成功，则说明文件夹创建成功，如下图：

![图片描述](https://doc.shiyanlou.com/courses/3472/1557563/3d560e1cb85f220b44302d2706e1e909-0/wm)

#### 获取文件接口测试

![图片描述](https://doc.shiyanlou.com/courses/3472/1557563/2c50e3cd131814e60758525ddbb9507d-0/wm)

#### 通过文件类型选择文件接口测试

由于目前上传文件接口还没有开发完成，因此通过文件类型选择文件接口只需要返回成功即可，测试结果如下图：

![图片描述](https://doc.shiyanlou.com/courses/3472/1557563/bb29794159545597aa666704c87ae800-0/wm)

## 实验总结

本实验主要是对网盘项目最基本的接口开发和测试，为后面开发文件上传功能打下基础。

本次实验完整代码可以通过如下命令进行下载：

```bash
wget https://labfile.oss.aliyuncs.com/courses/8842/code7.zip
```
