---
show: step
version: 1.0
enable_checker: true
---

# 文件的基本操作—删除、移动、下载和重命名

## 实验介绍

此次实验将带领大家实现文件删除、移动和下载的功能，同时支持对文件的单个和批量操作，以及文件重命名的实现。

#### 知识点

- Element UI 中 Tree 树形组件的使用、Table 表格组件中勾选框的使用
- `<a>` 标签实现文件下载

#### 开发计划

- 开发内容：
  1. 单文件操作：
      - 删除：使用 `$confirm` 服务完成删除提示功能
      - 移动：使用 Dialog 组件打开操作弹窗，Tree 组件展示文件夹的树形结构，选择移动文件的目标路径
      - 下载：使用 `<a>` 标签实现文件下载
      - 重命名：使用 Dialog 组件打开操作弹窗，在 Input 组件输入新的文件名
  2. 批量文件操作：利用 Table 组件的勾选框来获取批量操作的文件，删除、移动、下载功能的实现和单文件操作共用同个组件。
  3. 在右侧表格中添加**路径**列，点击路径，右侧表格显示该路径下的文件列表。
- 开发耗时：实验预计完成时间为 1.5~2 小时
- 开发难点：无

## 文件单个操作

对单个文件的操作，包括删除、移动、下载和重命名，操作入口在文件表格操作列的各个按钮。先来把接下来要用到的接口维护在 `src/request/file.js` 中：

```javascript
...
// 获取文件夹列表 树状结构
export const getFileTree = (p) => get('/file/getfiletree', p)

// 单文件操作接口
// 文件删除
export const deleteFile = (p) => post('/file/deletefile', p)
// 文件移动
export const moveFile = (p) => post('/file/movefile', p)
// 文件重命名
export const renameFile = (p) => post('/file/renamefile', p)
```

### 文件删除

在 `FileTable.vue` 中，已经将文件删除函数添加了，现在来在函数内部调用删除接口，在这之前，需要先提示用户是否确定删除，因此需要用到 Element UI 的 [MessageBox](https://element.eleme.cn/#/zh-CN/component/message-box#que-ren-xiao-xi) 组件。删除文件之后需要刷新文件列表：

```vue
<script>
import { deleteFile } from '@/request/file.js' //  引入接口

export default {
  name: 'FileTable',
  ...
  methods: {
    // 删除按钮 - 点击事件
    handleClickDelete(row) {
      // 消息弹框提示用户
      this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          // 确定按钮 点击事件 调用删除文件接口
          deleteFile(row).then((res) => {
            if (res.success) {
              this.$emit('getTableData') //  刷新文件列表
              this.$message.success('删除成功')
            } else {
              this.$message.error(res.message)
            }
          })
        })
        .catch(() => {
          //  取消
          this.$message({
            type: 'info',
            message: '已取消删除'
          })
        })
    },
    ...
  }
}
</script>
```

在 `src/views/Home/index.vue` 中接收子组件的刷新文件列表事件 `@getTableData="getFileData"`：

```vue
<!-- 表格组件 - 文件展示区 -->
<FileTable :tableData="tableData" :loading="loading" @getTableData="getFileData"></FileTable>
```

刷新首页，看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/1cd02ed2bbf7e282b971451a1bce38fd-0/wm" alt="15-1" style="zoom:67%;" />

### 文件移动

考虑到接下来的文件批量操作，把文件移动封装为公共组件。在 `src/views/Home/components` 下新建文件 `MoveFileDialog.vue`，内容稍后来讲。

在 `FileTable.vue` 中，已经将文件移动函数添加了，函数内部向父组件 `index.vue` 触发事件，以打开移动文件对话框，并保存当前行文件数据：

```javascript
// 移动按钮 - 点击事件
handleClickMove(row) {
    this.$emit('handleSelectFile', false, row) // true/false 操作类型：批量移动/单文件操作；row 当前行文件数据
    this.$emit('handleMoveFile', true) // true/false 打开/关闭移动文件对话框
},
```

父组件 `index.vue` 中接收事件，添加 `@handleSelectFile="setOperationFile"` 和 `@handleMoveFile="setMoveFileDialog"`：

```vue
<!-- 表格组件 - 文件展示区 -->
<FileTable
  :tableData="tableData"
  :loading="loading"
  @getTableData="getFileData"
  @handleSelectFile="setOperationFile"
  @handleMoveFile="setMoveFileDialog"
></FileTable>
```

回调函数内部执行操作：打开选择目标路径对话框，并保存当前行文件数据和操作类型，继续编辑 `index.vue` 文件：

```vue
<script>
...
import { getFileTree } from '@/request/file.js' //  引入获取文件夹列表 树状结构 接口

export default {
  name: 'Home',
  ...
  data() {
    return {
      ...
      //  移动文件模态框数据
      dialogMoveFile: {
        visible: false, //  对话框是否显示
        fileTree: [] //  目录树
      },
      isBatch: false, //  是否批量移动
      operationFile: {}, // 单个操作的文件信息
      operationFileList: [] // 批量操作的文件信息
    }
  },
  ...
  methods: {
    ...
    /**
     * 设置移动文件时的文件信息
     * @param {Boolean} isBatch 是否批量移动，true 是批量移动，false 是单个文件操作
     * @param {Object | Array} file 需要移动的文件信息，单个操作时为Oject，批量操作时，为Array
     */
    setOperationFile(isBatch, file) {
      this.isBatch = isBatch //  保存操作类型
      if (isBatch) {
        this.operationFileList = file //  批量操作文件
      } else {
        this.operationFile = file //  单个操作文件
      }
    },
    /**
     * 设置移动文件对话框相关数据
     * @param {Boolean} visible 打开/关闭移动文件模态框
     */
    setMoveFileDialog(visible) {
      this.dialogMoveFile.visible = visible //  打开对话框
      if (visible) {
        // 打开对话框时，获取文件夹目录树
        getFileTree().then((res) => {
          if (res.success) {
            this.dialogMoveFile.fileTree = [res.data]
          } else {
            this.$message.error(res.message)
          }
        })
      }
    }
  }
}
</script>
...
```

接下来添加 `MoveFileDialog.vue` 的内容：使用 Element UI 的 [Tree 树形控件](https://element.eleme.cn/#/zh-CN/component/tree#tree-shu-xing-kong-jian) ，在对话框内以树形结构显示文件夹，并使用树形控件的 `node-click` 事件，获取当前点击的文件夹路径，向父组件触发事件，在父组件中保存移动文件的目标路径。对话框点击确定按钮时，向父组件触发事件，在回调函数中调用移动文件接口；对话框点击取消按钮时，关闭对话框：

```vue
<template>
  <div class="move-dialog-wrapper">
    <!-- 移动文件-选择目录模态框 -->
    <el-dialog title="选择目录" :visible.sync="dialogMoveFile.visible">
      <div class="el-dialog-div">
        <el-tree
          :data="dialogMoveFile.fileTree"
          :props="defaultProps"
          :highlight-current="true"
          default-expand-all
          @node-click="selectNodeClick"
        ></el-tree>
      </div>
      <div slot="footer" class="dialog-footer">
        <el-button @click="$emit('handleMoveFile', false)">取 消</el-button>
        <el-button type="primary" @click="$emit('confirmMoveFile')">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'MoveFileDialog',
  props: {
    dialogMoveFile: Object
  },
  data() {
    return {
      defaultProps: {
        children: 'children',
        label: 'label'
      }
    }
  },
  methods: {
    //  移动文件模态框：选择目录事件
    selectNodeClick(data) {
      let selectFilePath = data.attributes.filePath ? data.attributes.filePath : '/'
      this.$emit('setSelectFilePath', selectFilePath)
    }
  }
}
</script>

<style lang="stylus" scoped>
.move-dialog-wrapper {
  >>> .el-dialog {
    .el-dialog__header {
      display: flex;
    }

    .el-dialog__body {
      padding: 10px 30px;

      .el-dialog-div {
        height: 300px;
        overflow: auto;
        setScrollbar(6px);

        .el-tree {
          .el-tree-node__content {
            height: 34px;
            font-size: 16px;

            .el-icon-caret-right {
              font-size: 18px;
            }
          }

          .el-tree-node.is-current>.el-tree-node__content {
            color: #409EFF;

            .el-tree-node__expand-icon {
              color: inherit;
            }
          }
        }
      }
    }
  }
}
</style>
```

在父组件 `index.vue` 中引入 `MoveFileDialog.vue`，并按照上述说明，在回调函数中添加相应操作：

```vue
<template>
  <div class="home">
    ...
    <!-- 3. 使用移动文件模态框 -->
    <MoveFileDialog
      :dialogMoveFile="dialogMoveFile"
      @setSelectFilePath="setSelectFilePath"
      @confirmMoveFile="confirmMoveFile"
      @handleMoveFile="setMoveFileDialog"
    ></MoveFileDialog>
  </div>
</template>

<script>
...
import MoveFileDialog from './components/MoveFileDialog' //  1. 引入移动文件组件
import { moveFile } from '@/request/file.js' //  引入获取文件列表接口

export default {
  name: 'Home',
  components: {
    ...
    MoveFileDialog //  2. 注册移动文件组件
  },
  data() {
    return {
      ...
      selectFilePath: '' //  目标路径
    }
  },
  methods: {
    ...
    //  设置移动文件的目标路径
    setSelectFilePath(selectFilePath) {
      this.selectFilePath = selectFilePath
    },
    //  移动文件模态框-确定按钮事件
    confirmMoveFile() {
      if (this.isBatch) {
        //  批量移动
      } else {
        //  单文件移动
        let data = {
          filePath: this.selectFilePath, //  目标路径
          oldFilePath: this.operationFile.filePath, //  原路径
          fileName: this.operationFile.fileName, //  文件名称
          extendName: this.operationFile.extendName //  文件扩展名
        }
        moveFile(data).then((res) => {
          if (res.success) {
            this.$message.success('移动文件成功')
            this.getFileData() //  刷新文件列表
            this.dialogMoveFile.visible = false //  关闭对话框
          } else {
            this.$message.error(res.message)
          }
        })
      }
    }
  }
}
</script>
...
```

刷新首页，看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/653ca0444c7a5c5afdacb2428524a695-0/wm" alt="15-2" style="zoom:67%;" />

### 文件下载

下载按钮添加显隐控制 `v-if="scope.row.isDir === 0"`，当前行的文件类型不是文件夹时才可下载，同时在 `<a>` 标签的 href 属性中添加下载链接，修改 `FileTable.vue` 文件：

```vue
<!-- 操作列展开状态下的下载按钮 -->
<el-button type="text" size="small" v-if="scope.row.isDir === 0">
    <a
       :href="`/api/filetransfer/downloadfile?userFileId=${scope.row.userFileId}`"
       target="_blank"
       style="display: block; color: inherit"
       >下载</a
     >
</el-button>
...

<!-- 操作列收缩状态下的下载按钮 -->
<el-dropdown-item v-if="scope.row.isDir === 0">
    <a
       :href="`/api/filetransfer/downloadfile?userFileId=${scope.row.userFileId}`"
       target="_blank"
       style="display: block; color: inherit"
       >下载</a
    >
</el-dropdown-item>
```

来处理下 `<a>` 标签的下划线，在 `src/assets/style/base.styl` 中添加样式：

```stylus
a {
  text-decoration: none;
}
```

刷新首页，看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/1bcca550ba4e55273d76ceed5fe4bf7e-0/wm" alt="15-3" style="zoom:67%;" />

### 文件重命名

在 `FileTable.vue` 中，文件重命名的函数已添加，函数内部执行以下操作：先打开消息弹框让用户输入新文件名，点击确定按钮后，调用重命名接口。

```vue
<script>
import { renameFile } from '@/request/file.js' //  引入文件重命名接口

export default {
  name: 'FileTable',
  ...
  methods: {
    ...
    // 重命名按钮 - 点击事件
    handleClickRename(row) {
      var fileName = row.fileName
      this.$prompt('请输入文件名', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        inputValue: fileName,
        inputPattern: /\S/, //  文件名不能为空
        inputErrorMessage: '请输入文件名',
        closeOnClickModal: false
      })
        .then(({ value }) => {
          // 确定按钮 调用重命名接口
          renameFile({
            ...row,
            fileName: value
          }).then((res) => {
            if (res.success) {
              this.$emit('getTableData') //  刷新文件列表
              this.$message.success('文件已重命名')
            } else {
              this.$message.error(res.message)
            }
          })
        })
        .catch(() => {
          this.$message({
            type: 'info',
            message: '取消'
          })
        })
    }
  }
}
</script>
```

刷新首页，看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/5edfbe357392e94fd9c2f5ba983f1a67-0/wm" alt="15-4" style="zoom:67%;" />

## 文件批量操作

对文件的批量操作，包括删除、移动、下载，文件的选择需要在表格列的每行添加勾选框，操作按钮将会放置在顶部的操作按钮组中。操作流程如下：

1. 勾选需要批量操作的表格行，保存用户已勾选的表格行；
2. 点击批量操作按钮（删除/移动/下载）；
3. 执行批量操作；
4. 批量操作结束，刷新文件列表。

先来把接下来要用到的接口维护在 `src/request/file.js` 中：

```javascript
// 批量文件操作接口
// 批量删除文件
export const batchDeleteFile = (p) => post('/file/batchdeletefile', p)
// 批量移动文件
export const batchMoveFile = (p) => post('/file/batchmovefile', p)
```

### 文件列表勾选框添加

在 `FileTable.vue` 中，参考 Element UI 的[多选表格官方示例](https://element.eleme.cn/#/zh-CN/component/table#duo-xuan)在表格第一列前添加 `type="selection"` 的列，并在表格上添加 `@selection-change="handleSelectRow"`，当选择项发生变化时会触发该事件，并将已选项通过事件抛出，在父组件中保存：

```vue
<template>
  <el-table
    class="file-table"
    :data="tableData"
    height="calc(100vh - 202px)"
    style="width: 100%"
    v-loading="loading"
    @selection-change="handleSelectRow"
  >
    <!-- 勾选框 -->
    <el-table-column type="selection" width="56" align="center"></el-table-column>
    <!-- 已有代码不再赘述 -->
    ...
  </el-table>
</template>

<script>
export default {
  name: 'FileTable',
  methods: {
    ...
    // 表格行勾选事件
    handleSelectRow(selection) {
      this.$emit('handleSelectFile', true, selection) // true/false 批量移动/单文件操作；selection 勾选的表格行数据
    },
    ...
  }
}
</script>
```

在父组件 `index.vue` 中将保存的已选项数据 `operationFileList`，传递给操作按钮组：

```vue
<OperationMenu
  :fileType="fileType"
  :filePath="filePath"
  :operationFileList="operationFileList"
  @getTableData="getFileData"
  @handleUploadFile="handleUploadFile"
></OperationMenu>
```

在操作按钮组组件 `OperationMenu.vue` 中，接收该值，这样批量删除、批量下载的事件均在此组件中执行即可：

```javascript
props: {
    ...
    // 表格行 已选项
    operationFileList: {
        type: Array,
        required: true
    }
  },
```

### 文件批量删除

在操作按钮组组件 `OperationMenu.vue` 中添加删除按钮，并添加按钮点击事件：

```vue
<!-- 按钮组 -->
<el-button-group class="operate-group">
    <!-- 已有代码不再赘述 -->
    ...
    <!-- disabled 当表格勾选项为空时，禁用删除按钮 -->
    <el-button
        size="mini"
        type="primary"
        icon="el-icon-delete"
        :disabled="!operationFileList.length"
        @click="handleDeleteFileClick()"
        >删除</el-button
    >
  </el-button-group>
```

在按钮点击事件中，和删除单文件步骤类似，询问用户是否确定删除，确定时调用批量删除文件接口，删除成功后刷新文件列表，继续编辑 `OperationMenu.vue` 文件：

```vue
<script>
...
import { batchDeleteFile } from '@/request/file.js' //  引入批量删除文件接口

export default {
  name: 'OperationMenu',
  methods: {
    ...
    // 删除文件按钮 - 点击事件
    handleDeleteFileClick() {
      // 消息弹框提示用户
      this.$confirm('此操作将永久删除文件, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          // 确定按钮 点击事件 调用批量删除文件接口
          batchDeleteFile({
            files: JSON.stringify(this.operationFileList)
          }).then((res) => {
            if (res.success) {
              this.$message({
                message: res.message,
                type: 'success'
              })
              this.$emit('getTableData') //  刷新文件列表
            } else {
              this.$message.error('失败' + res.message)
            }
          })
        })
        .catch(() => {
          //  取消
          this.$message({
            type: 'info',
            message: '已取消删除'
          })
        })
    }
  }
}
</script>
```

刷新首页，看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/b6477831dc0fdff8483791204faba4fb-0/wm" alt="15-5" style="zoom:67%;" />

### 文件批量移动

在实现单文件移动时，已经将文件夹列表的展示封装为了公共组件，这里还是使用该组件选择目标路径，在`OperationMenu.vue` 中向父组件中抛出事件，打开路径选择对话框。

先在 `OperationMenu.vue` 中添加移动按钮，这里需要做个显隐控制：只有左侧菜单选择全部时，才显示移动按钮；并给移动按钮添加点击事件：

```vue
<!-- 按钮组 -->
<el-button-group class="operate-group">
    <!-- 已有代码不再赘述 -->
    ...
    <!-- disabled 当表格勾选项为空时，禁用移动按钮 | v-if 当左侧菜单选择全部时，才显示移动按钮 -->
    <el-button
        size="mini"
        type="primary"
        icon="el-icon-rank"
        :disabled="!operationFileList.length"
        v-if="fileType === 0"
        @click="handleMoveFileClick()"
        >移动</el-button
    >
</el-button-group>
```

```javascript
// 移动文件按钮 - 点击事件
handleMoveFileClick() {
    // true/false 批量移动/单文件操作 | this.operationFileList 当前行文件数据
    this.$emit('handleSelectFile', true, this.operationFileList)
    this.$emit('handleMoveFile', true) // true/false 打开/关闭移动文件对话框
}
```

在父组件 `index.vue` 中接收事件 `@handleSelectFile` 和 `@handleMoveFile`：

```vue
<OperationMenu
  :fileType="fileType"
  :filePath="filePath"
  :operationFileList="operationFileList"
  @getTableData="getFileData"
  @handleUploadFile="handleUploadFile"
  @handleSelectFile="setOperationFile"
  @handleMoveFile="setMoveFileDialog"
></OperationMenu>
```

在回调函数 `setMoveFileDialog()` 内打开目标路径选择对话框，对话框点击确定按钮时，需要在回调函数 `confirmMoveFile()` 中调用批量移动文件接口：

```javascript
import { batchMoveFile } from '@/request/file.js'

//  移动文件模态框-确定按钮事件
confirmMoveFile() {
    if (this.isBatch) {
    	//  批量移动
        let data = {
          filePath: this.selectFilePath,
          files: JSON.stringify(this.operationFileList)
        }
        batchMoveFile(data).then((res) => {
          if (res.success) {
            this.$message.success(res.data)
            this.getFileData() //  刷新文件列表
            this.dialogMoveFile.visible = false //  关闭对话框
            this.operationFileList = []
          } else {
            this.$message.error(res.message)
          }
        })
    } else {
        //  单文件移动
        //  ......已有代码不再赘述
        ...
    }
}
```

刷新页面，看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/8a737ff705c7a3b3f5b2b1d75c230e92-0/wm" alt="15-6" style="zoom:67%;" />

### 文件批量下载

文件下载仍然采用 `<a>` 标签来实现，点击下载按钮时，触发 `<a>` 的点击事件，开始下载文件。在 `OperationMenu.vue` 中添加以下内容，同样需要做按钮禁用处理：

```vue
<template>
  <div class="operation-menu-wrapper">
    <!-- 按钮组 -->
    <el-button-group class="operate-group">
      <!-- 已有代码不再赘述 -->
      ...
      <!-- disabled 当表格勾选项为空时，禁用下载按钮 -->
      <el-button
        size="mini"
        type="primary"
        icon="el-icon-download"
        :disabled="!operationFileList.length"
        @click="handleDownloadFileClick()"
        >下载</el-button
      >
    </el-button-group>
    ...
    <!-- 多选文件下载，页面隐藏 -->
    <a
      v-for="(item, index) in operationFileList"
      :key="index"
      :href="`/api/filetransfer/downloadfile?userFileId=${item.userFileId}`"
      :download="`${item.fileName}.${item.extendName}`"
      :ref="`downloadLink${index}`"
    ></a>
  </div>
</template>

<script>
export default {
  name: 'OperationMenu',
  ...
  methods: {
    ...
    // 下载文件按钮 - 点击事件
    handleDownloadFileClick() {
      for (let i = 0; i < this.operationFileList.length; i++) {
        this.$refs[`downloadLink${i}`][0].click() //  依次调用 a 标签的点击事件来下载文件
      }
    }
  }
}
</script>
```

刷新首页，来看下效果：

<img src="https://doc.shiyanlou.com/courses/3472/1557563/fe880af7e61f0fe8d2dbaa5f018019eb-0/wm" alt="15-7" style="zoom:67%;" />

## 完善文件表格数据回显

当左侧菜单点击**图片/文档/视频/音乐/其他**时，在右侧表格中添加一列——文件所在路径；点击路径，可以直接跳转到该路径下，右侧表格显示该路径下的文件列表。

把 fileType 传递给文件表格组件，在 `index.vue` 中添加 `:fileType="fileType"`：

```vue
<!-- 表格组件 - 文件展示区 -->
<FileTable
  :tableData="tableData"
  :loading="loading"
  :fileType="fileType"
  @getTableData="getFileData"
  @handleSelectFile="setOperationFile"
  @handleMoveFile="setMoveFileDialog"
></FileTable>
```

在 `FileTable.vue` 中接收 fileType：

```javascript
props: {
    // 文件类型
    fileType: {
        type: Number,
        required: true
    }
}
```

在 `FileTable.vue` 中实现跳转功能：

```vue
<el-table
  class="file-table"
  :data="tableData"
  height="calc(100vh - 202px)"
  style="width: 100%"
  v-loading="loading"
  @selection-change="handleSelectRow"
>
    <!-- 已有代码不再赘述 -->
    ...
    <el-table-column
      label="所在路径"
      prop="filePath"
      show-overflow-tooltip
      v-if="fileType !== 0"
    >
      <template slot-scope="scope">
        <div
          style="cursor: pointer"
          title="点击跳转"
          @click="
            $router.push({
              query: { fileType: 0, filePath: scope.row.filePath }
            })
          "
        >
          {{ scope.row.filePath }}
        </div>
      </template>
    </el-table-column>
    ...
</el-table>
```

刷新首页，看下效果：

![15-8](https://doc.shiyanlou.com/courses/3472/1557563/799577a8fada37d77466d52037f13834-0/wm)

## 实验总结

此次实验实现了对文件的单个和批量操作，包括删除、移动、下载、重命名，并完善了文件表格的数据回显，至此网盘的主要功能已全部实现。

本次实验完整代码可以通过如下命令进行下载：

```bash
wget https://labfile.oss.aliyuncs.com/courses/3472/code15.zip
```
